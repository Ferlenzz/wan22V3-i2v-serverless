name: Docker Build & Push

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: {}

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Fetch VideoCrafter2 sources (mirrored tarballs)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf vc2 /tmp/vc2 /tmp/vc2.zip
          mkdir -p /tmp/vc2
          URLS="
          https://gitcode.com/mirrors/OpenGVLab/VideoCrafter2/archive/main.zip
          https://gitcode.net/mirrors/OpenGVLab/VideoCrafter2/archive/main.zip
          https://gitee.com/mirrors/OpenGVLab/VideoCrafter2/repository/archive/main.zip
          https://hub.fastgit.org/OpenGVLab/VideoCrafter2/archive/refs/heads/main.zip
          https://download.nju.edu.cn/github/OpenGVLab/VideoCrafter2/archive/refs/heads/main.zip
          https://ghproxy.com/https://github.com/OpenGVLab/VideoCrafter2/archive/refs/heads/main.zip
          https://ghproxy.com/https://codeload.github.com/OpenGVLab/VideoCrafter2/zip/refs/heads/main
          https://github.com/OpenGVLab/VideoCrafter2/archive/refs/heads/main.zip
          "
          ok=0
          for u in $URLS; do
            echo "Try: $u"
            rm -f /tmp/vc2.zip
            if curl -L --fail --connect-timeout 20 --retry 3 -o /tmp/vc2.zip "$u"; then
              unzip -q /tmp/vc2.zip -d /tmp/vc2 || true
              vc2dir=$(find /tmp/vc2 -maxdepth 1 -type d -iname "*videocrafter2*" | head -n1 || true)
              if [ -n "$vc2dir" ]; then
                mkdir -p vc2
                shopt -s dotglob
                cp -r "$vc2dir"/* vc2/
                ok=1
                break
              fi
            fi
          done
          if [ "$ok" -ne 1 ]; then
            echo "FATAL: cannot download VideoCrafter2 sources from mirrors"
            exit 1
          fi
          test -f vc2/README.md || { echo "FATAL: vc2/README.md not found"; exit 1; }
          ls -la vc2 | head

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/vc2-i2v:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
